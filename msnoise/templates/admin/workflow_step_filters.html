# Add this to your template globals or create a custom template for the workflow steps form

WORKFLOW_STEPS_FORM_TEMPLATE = """
{% extends 'admin/model/edit.html' %}

{% block tail %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Handle step type changes for parent selection
        $('#step_type').on('change', function() {
            var stepType = $(this).val();
            var parentSelect = $('#parent_step_ref');
            var currentStepId = $('input[name="id"]').val() || '';

            if (stepType) {
                $.ajax({
                    url: '{{ url_for("workflowsteps.get_valid_parents") }}',
                    data: {
                        step_type: stepType,
                        current_step_id: currentStepId
                    },
                    success: function(data) {
                        parentSelect.empty();
                        parentSelect.append('<option value="">No parent (root step)</option>');

                        $.each(data.parents, function(index, parent) {
                            parentSelect.append('<option value="' + parent.id + '">' + parent.text + '</option>');
                        });

                        // Trigger change to update filters field visibility
                        parentSelect.trigger('change');
                    }
                });
            }
        });

        // Handle parent selection changes
        $('#parent_step_ref').on('change', function() {
            var parentId = $(this).val();
            var filtersField = $('.filters-field').closest('.form-group');

            if (parentId) {
                // Child step - hide filters field
                filtersField.hide();
                // Clear filter selections
                $('.filters-field option').prop('selected', false);
            } else {
                // Root step - show filters field
                filtersField.show();
            }

            // Validate parent selection
            if (parentId) {
                var stepType = $('#step_type').val();
                var currentStepId = $('input[name="id"]').val() || '';

                $.ajax({
                    url: '{{ url_for("workflowsteps.validate_parent_selection") }}',
                    data: {
                        step_type: stepType,
                        parent_id: parentId,
                        current_step_id: currentStepId
                    },
                    success: function(data) {
                        if (!data.valid) {
                            alert('Invalid parent selection: ' + data.message);
                            $('#parent_step_ref').val('');
                        }
                    }
                });
            }
        });

        // Initialize on page load
        $('#step_type').trigger('change');
    });
</script>
{% endblock %}
"""

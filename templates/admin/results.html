{% extends 'admin/master.html' %}

{% block head %}
<script type='text/javascript' src='//code.jquery.com/jquery-2.0.2.js'></script>
<link rel="stylesheet" type="text/css" href="http://cdn.pydata.org/bokeh-0.4.4.css">
<script type='text/javascript' src="/static/admin/bokeh-0.4.4.js"></script>
<script type="text/coffeescript">

window.source = Bokeh.Collections('ColumnDataSource').create(
  data:
    x: [-120,120]
    y: [-1,1]
)

line = {
  type: 'line'
  x: 'x'
  y: 'y'
  line_color:  "#000000"  
  line_width: 2
}

options = {
  title: "Stacked CCF"
  dims: [1000, 500]
  xrange: 'auto'
  yrange: 'auto'
  xaxes: "min"
  yaxes: "min"
  tools: "pan,wheel_zoom,box_zoom,reset,resize"
}

plot = Bokeh.Plotting.make_plot(line, window.source, options)
Bokeh.Plotting.show(plot,'#CCF')


#
# Update the plot data on an interval
# 
Array::max=->
  Math.max.apply(null, this)
 
Array::min=->
  Math.min.apply(null, this)
  
@update = (newdata) ->
    data = window.source.get('data')
    if newdata['info'] == "No Data"
        console.debug('No Data was received')
        data['x'] = [0,1]
        data['y'] = [0,0]
    
    else
        data['x'] = newdata['x']
        data['y'] = newdata['y']

        window.source.set('data', data)
        window.source.trigger('change', source, {})

        newrange = {}
        newrange['xr'] = {'start':data['x'].min(), 'end':data['x'].max()}
        newrange['yr'] = {'start':data['y'].min(), 'end':data['y'].max()}
        window.pview.update_range(newrange)
    window.source.set('data', data)
    window.source.trigger('change', source, {})
</script>
<script type="text/javascript" src="/static/admin/coffeescript.js"></script>

<script>

function get_CCF(callback, arg) {
    $.ajax({
        url:'/admin/all_results.json',
        type:'POST',
        dataType: 'json',
        contentTtupe: 'application/json',
        data: JSON.stringify(arg),
        success: callback
        });
    };

function get_pairs(callback) {
    $.ajax({
        url:'/admin/pairs.json',
        type:'GET',
        dataType: 'json',
        success: callback
        });
    };

function populate_pair(data) {
    $.each(data, function(i, value) {
        $('#pair').append($('<option>').text(value).attr('value', value));
    });
    $('#pair').change();
}


function get_filters(callback) {
    $.ajax({
        url:'/admin/filters.json',
        type:'GET',
        dataType: 'json',
        success: callback
        });
    };

function populate_filter(data) {
    console.debug("%o",data);
    $.each(data, function(i, value) {
        $('#filter').append($('<option>').text(value).attr('value', i));
    });
    $('#filter').change();
}

function get_components(callback) {
    $.ajax({
        url:'/admin/components.json',
        type:'GET',
        dataType: 'json',
        success: callback
        });
    };

function populate_component(data) {
    console.debug("%o",data);
    $.each(data, function(i, value) {
        $('#component').append($('<option>').text(value).attr('value', i));
    });
    $('#component').change();
}



function updateplot() {
    var pair = $('#pair option:selected').text()
    var filter = $('#filter option:selected').val()
    var component = $('#component option:selected').text()
    var format = "stack"
    var arg = {"pair": pair,"component": component,"filter":filter,"format":format}
    console.debug(arg);
    get_CCF(update, arg);
    }

$(document).ready(function() {
    get_filters(populate_filter);
    get_components(populate_component);
    get_pairs(populate_pair);
    
    $('#pair').change(function() {
        updateplot()
    });
    
    $('#update').click(function() {
        updateplot()
    });
    
});
</script>
{% endblock %}

{% block body %}
{{ super() }}

<h1 class="page-header">{{ admin_view.view_title }}</h1>
  <label for="filter">Filter:</label><select id="filter" name="filter" ></select><br>
  <label for="component">Component:</label><select id="component" name="component" ></select><br>
  <label for="pair">Pair:</label><select id="pair" name="pair" ></select><br>
  <button id="update" type="submit" class="btn btn-default">Update</button>
  <div id="CCF" name="CCF"></div>


{% endblock body %}
